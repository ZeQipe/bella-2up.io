# Casino Telegram Bot

Телеграм бот для консультирования клиентов онлайн казино с поддержкой различных персон и AI-генерированными ответами.

## Архитектура

### Компоненты системы

1. **Telegram Bot** - Основной интерфейс взаимодействия с пользователями
2. **SQLite Database** - Хранение истории сообщений и состояний чатов
3. **Redis** - Кеширование контекста (будет добавлено позже)
4. **DeepSeek AI** - Генерация ответов (интеграция планируется)
5. **ChromaDB** - Векторная база знаний (интеграция планируется)
6. **OpenAI Embeddings** - Создание эмбеддингов для поиска (интеграция планируется)

### Структура проекта

```
├── app/                    # Основной код приложения
│   ├── handlers/          # Обработчики Telegram событий
│   ├── services/          # Сервисы для внешних интеграций
│   ├── config.py          # Конфигурация приложения
│   ├── database.py        # Работа с базой данных
│   └── models.py          # Модели данных
├── data/                  # Данные приложения (БД, векторы)
├── kb/                    # База знаний (txt файлы)
├── prompts/              # Системные промты для AI
├── main.py               # Точка входа приложения
├── requirements.txt      # Python зависимости
├── Dockerfile           # Конфигурация Docker
└── docker-compose.yml   # Оркестрация сервисов
```

## Функциональность

### Персоны бота

Бот поддерживает 3 типа персон:

1. **Деловой режим** - Строгий, профессиональный стиль техподдержки
2. **Белла** - Женская персона с легким флиртом
3. **Бэн** - Мужская персона с легким флиртом

### Основные возможности

- ✅ Сохранение истории диалогов (до 20 сообщений на пользователя)
- ✅ Переключение между персонами через кнопки
- ✅ Очистка истории командой `/start`
- ✅ Обработка ошибок с fallback сообщениями
- ✅ Векторная база знаний с ChromaDB и OpenAI эмбеддингами
- ✅ Автоматическое создание векторов из txt файлов при запуске
- ✅ Семантический поиск по базе знаний с настраиваемыми порогами
- ⏳ Интеграция с DeepSeek AI (планируется)
- ⏳ Поддержка множественных языков (EN/JA) (планируется)

## Установка и запуск

### Локальный запуск

1. Клонируйте репозиторий
2. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```

3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

4. Скопируйте и настройте переменные окружения:
   ```bash
   cp env.example .env
   # Отредактируйте .env файл, добавьте токен бота
   ```

5. Запустите бота:
   ```bash
   python main.py
   ```

### Запуск через Docker

1. Скопируйте и настройте переменные окружения:
   ```bash
   cp env.example .env
   # Отредактируйте .env файл
   ```

2. Запустите через Docker Compose:
   ```bash
   docker-compose up -d
   ```

3. Просмотр логов:
   ```bash
   docker-compose logs -f telegram-bot
   ```

## Конфигурация

### Основные переменные окружения

- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота (обязательно)
- `DATABASE_PATH` - Путь к SQLite базе данных
- `MESSAGE_HISTORY_LIMIT` - Лимит сообщений в истории (по умолчанию 20)
- `ERROR_MESSAGE` - Сообщение при ошибках API

### Векторная система

- `OPENAI_API_KEY` - Ключ API OpenAI для создания эмбеддингов (обязательно)
- `OPENAI_EMBEDDING_MODEL` - Модель для эмбеддингов (по умолчанию text-embedding-3-small)
- `VECTOR_SEARCH_LIMIT` - Количество векторов для поиска (по умолчанию 8)
- `VECTOR_SIMILARITY_THRESHOLD` - Порог схожести для фильтрации (по умолчанию 0.7)
- `VECTOR_REBUILD_ON_CHANGES` - Пересоздавать векторы при изменении файлов (по умолчанию true)

### Промоакции

- Файл с промоакциями: по умолчанию `prompts/promotions.txt` (переменная `PROMOTIONS_FILE`)
- Содержимое файла подставляется в `{promotions}` системного промта при каждом запросе
- Если вы храните промо в `kb/`, файл с именем `promotions.txt` будет исключен из эмбеддингов

### Будущие интеграции

- `DEEPSEEK_API_KEY` - Ключ API DeepSeek
- `REDIS_URL` - URL подключения к Redis

## Разработка

### Этапы развития

1. ✅ **Этап 1**: Каркас бота с базовой функциональностью
2. ⏳ **Этап 2**: Интеграция с DeepSeek AI (в процессе)
3. ✅ **Этап 3**: Векторная база знаний с ChromaDB
4. ⏳ **Этап 4**: Оптимизация и тестирование

## Тестирование векторной системы

Для проверки работоспособности векторной системы:

```bash
# Установите OpenAI API ключ
export OPENAI_API_KEY="your-openai-api-key"

# Запустите тесты
python run_vector_tests.py

# Или через pytest
pytest tests/test_vector_system.py -v
```

Тесты проверяют:
- ✅ Создание эмбеддингов через OpenAI API
- ✅ Инициализацию векторной базы из txt файлов
- ✅ Сохранение и загрузку векторов в ChromaDB
- ✅ Семантический поиск с настраиваемыми порогами
- ✅ Добавление новых документов
- ✅ Интеграционные тесты полного цикла

### Расширение функциональности

Архитектура спроектирована для легкого расширения:

- **Новые персоны**: добавить в `PersonaType` enum и обновить конфигурацию
- **Новые языки**: расширить логику определения языка в обработчиках
- **Новые AI провайдеры**: реализовать `AIServiceInterface`
- **Интеграция с сайтом**: добавить REST API эндпоинты

## Мониторинг

Логирование настроено через `structlog` с JSON форматом для легкой интеграции с системами мониторинга.

Уровни логов:
- `INFO` - Основные события (запуск, обработка команд)
- `DEBUG` - Детальная отладочная информация
- `ERROR` - Ошибки и исключения
- `WARNING` - Предупреждения

## Безопасность

- Непривилегированный пользователь в Docker контейнере
- Валидация входных данных
- Обработка всех исключений
- Логирование без чувствительной информации
